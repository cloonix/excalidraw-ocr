services:
  # Watch mode service - automatically process new Excalidraw files
  # Usage: docker compose up -d
  excalidraw-ocr:
    image: ghcr.io/cloonix/excalidraw-ocr:latest
    container_name: excalidraw-ocr

    command: ["python", "excalidraw_ocr.py", "/watch", "-w"]

    volumes:
      - ./watch:/watch
      - ./.env:/app/.env:ro
      - watch-logs:/home/ocruser/.ocr/logs

    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DEBUG=${DEBUG:-}
      - STABILIZATION_DELAY_MINUTES=${STABILIZATION_DELAY_MINUTES:-15}

    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:size=1G,mode=1777

    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 512M
        reservations:
          cpus: "1"
          memory: 256M
      restart_policy:
        condition: unless-stopped
        delay: 5s
        max_attempts: 3
        window: 120s

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

    user: "1000:1000"
    network_mode: bridge
    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python.*excalidraw_ocr.py.*-w' || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 2
      start_period: 30s

volumes:
  watch-logs:
    driver: local
