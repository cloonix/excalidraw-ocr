version: '3.8'

services:
  excalidraw-watch:
    build:
      context: .
      dockerfile: Dockerfile
    image: ocr-app:latest
    container_name: excalidraw-watch
    
    # Watch mode command
    command: ["python", "excalidraw_ocr.py", "/watch", "-w"]
    
    # Volumes
    volumes:
      # Watch directory (read-write for outputs)
      - ./watch:/watch
      # Environment file (read-only)
      - ./.env:/app/.env:ro
      # Persistent logs
      - watch-logs:/home/ocruser/.ocr/logs
    
    # Environment variables
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DEBUG=${DEBUG:-}
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    read_only: false  # Need write for temp files
    tmpfs:
      # Temporary filesystem for secure temp file handling
      - /tmp:size=1G,mode=1777
    
    # Resource limits (increased for watch mode)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 3G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # File descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    
    # User (non-root)
    user: "1000:1000"
    
    # Network
    network_mode: bridge
    
    # Restart policy
    restart: unless-stopped
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python.*excalidraw_ocr.py.*-w' || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 2
      start_period: 30s

volumes:
  watch-logs:
    driver: local
